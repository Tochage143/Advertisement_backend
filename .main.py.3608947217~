from flask import Flask,abort,jsonify,request,render_template
from bs4 import BeautifulSoup
import json
import requests



app = Flask(__name__)

def get_anime_data(data):
    soup = BeautifulSoup(data, "html.parser")
    animebox = soup.find_all('div', class_='flw-item')
    animedata = []
    if animebox is None:
        return  animedata

    for x in animebox:
        idtag = x.find("a")
        id = idtag.get("href").strip('/')
        title = idtag.get("title")
        imgtag = x.find("img").get("data-src")
        subtag = x.find('div', class_='tick-sub')
        dubtag = x.find('div', class_='tick-dub')
        ratetag = x.find('div', class_='tick-rate')

        sub = subtag.text if subtag else None
        dub = dubtag.text if dubtag else None
        rate = ratetag.text if ratetag else None

        jsondata = {
            "id": id,
            "name": title,
            'poster': imgtag,
            "rating": rate,
            "episodes": {
               "sub": sub,
                "dub": dub,
                },
         }

        animedata.append(jsondata)

    return animedata

@app.route('/')
def index():
    return 'Hello from Flask!'

@app.route("/anime/<string:animedetail>") 
def Get_anime_detail(animedetail):
    page = request.args.get('page',1)
    baseurl = "https://aniwatch.to/"
    res = requests.get(baseurl+animedetail+"?page="+page)
    if res.status_code == 200:
        anime_data=get_anime_data(res.text)
        return jsonify(anime_data)        
    else:
      return  abort(404)
    

@app.route("/home")    
def home():
    list_item=["movie","subbed-anime","dubbed-anime",'most-popular','tv','special','most-favorite','top-airing']
    baseurl = "https://aniwatch.to/"
    animehome={}
    for x in list_item:
        res = requests.get(baseurl+x)
        if res.status_code == 200:
            anime_data_=get_anime_data(res.text)
            
        
            animehome[x]=anime_data_[0:20]
    return jsonify(animehome)
    
@app.route("/jav/<string:name>")
def Jav(name):

    headers = {
        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.64 Safari/537.36 Edg/101.0.1210.53',
        'referer': 'https://missav.com/'
    }
    url = "https://missav.com/search/"
    res = requests.get("https://missav.com/en/"+name,headers=headers)
    if res.status_code == 200:
        soup=BeautifulSoup(res.text,"html.parser")
        script_data=soup.find_all("script")
        for script in script_data:
            pass
    return res.text
app.run(host='0.0.0.0', port=81,debug=True)
